<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>AWS IoT Web</title>

  <!-- AWS SDK -->
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1370.0.min.js"></script>

  <!-- AWS IoT Device SDK (BROWSER BUNDLE) -->
  <script src="https://unpkg.com/aws-iot-device-sdk/browser/aws-iot-sdk-browser-bundle.min.js"></script>
</head>
<body>

<h2>AWS IoT + Cognito (Web)</h2>
<button onclick="conectarIoT()">Conectar a AWS IoT</button>

<pre id="log"></pre>

<script>
const log = (m) => {
  console.log(m);
  document.getElementById("log").textContent += m + "\n";
};

const awsConfig = {
  region: "us-east-1",
  identityPoolId: "us-east-1:7860e2f2-eb64-4494-9c2a-fe735c8912ec",
  iotEndpoint: "a1eyoxsww0xvbl-ats.iot.us-east-1.amazonaws.com"
};

log("üìÑ HTML cargado");

AWS.config.region = awsConfig.region;
AWS.config.credentials = new AWS.CognitoIdentityCredentials({
  IdentityPoolId: awsConfig.identityPoolId
});

function conectarIoT() {
  log("üîÑ Obteniendo credenciales Cognito...");

  AWS.config.credentials.get((err) => {
    if (err) {
      log("‚ùå Error Cognito: " + err);
      return;
    }

    log("‚úÖ Credenciales OK");

    const client = awsIot.device({
      region: awsConfig.region,
      protocol: "wss",
      host: awsConfig.iotEndpoint,
      clientId: "web-" + Math.random().toString(16).substr(2, 8),
      accessKeyId: AWS.config.credentials.accessKeyId,
      secretKey: AWS.config.credentials.secretAccessKey,
      sessionToken: AWS.config.credentials.sessionToken,
      debug: true
    });

    client.on("connect", () => {
      log("üöÄ CONECTADO A AWS IOT");
      client.subscribe("esp32/test");
    });

    client.on("message", (topic, payload) => {
      log(`üì© ${topic}: ${payload.toString()}`);
    });

    client.on("error", (e) => {
      log("‚ùå IoT error: " + e.message);
    });
  });
}
</script>

</body>
</html>
