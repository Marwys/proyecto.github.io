<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AWS IoT Web</title>
  <!-- AWS SDK -->
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1370.0.min.js"></script>
  <!-- AWS IoT Device SDK -->
  <script src="https://unpkg.com/aws-iot-device-sdk@2.2.13/browser/aws-iot-sdk-browser-bundle.js"></script>
</head>
<body>
<h2>AWS IoT Web - Prueba de Conexi√≥n</h2>
<button onclick="conectar()">Conectar a AWS IoT</button>
<button onclick="publicar()" id="btnPublicar" disabled>Publicar Mensaje</button>
<button onclick="limpiar()">Limpiar Log</button>
<pre id="log"></pre>

<script>
let client = null;

const log = (m) => {
  const timestamp = new Date().toLocaleTimeString();
  const msg = `[${timestamp}] ${m}`;
  console.log(msg);
  document.getElementById("log").textContent += msg + "\n";
  // Auto-scroll
  document.getElementById("log").scrollTop = document.getElementById("log").scrollHeight;
};

function limpiar() {
  document.getElementById("log").textContent = "";
}

log("üìÑ P√°gina cargada");
log("AWS SDK: " + (typeof AWS !== 'undefined' ? '‚úÖ' : '‚ùå'));
log("awsIot SDK: " + (typeof awsIot !== 'undefined' ? '‚úÖ' : '‚ùå'));

const cfg = {
  region: "us-east-1",
  identityPoolId: "us-east-1:7860e2f2-eb64-4494-9c2a-fe735c8912ec",
  iotEndpoint: "a1eyoxsww0xvbl-ats.iot.us-east-1.amazonaws.com"
};

// Configurar AWS
AWS.config.region = cfg.region;
AWS.config.credentials = new AWS.CognitoIdentityCredentials({
  IdentityPoolId: cfg.identityPoolId
});

function conectar() {
  log("üîÑ Iniciando conexi√≥n...");
  log("üîë Solicitando credenciales de Cognito...");
  
  AWS.config.credentials.get((err) => {
    if (err) {
      log("‚ùå Error obteniendo credenciales: " + err.message);
      return;
    }
    
    log("‚úÖ Credenciales obtenidas");
    log("üîê AccessKeyId: " + AWS.config.credentials.accessKeyId.substring(0, 10) + "...");
    
    try {
      const clientId = "web-client-" + Math.floor(Math.random() * 100000);
      log("üì± ClientId: " + clientId);
      
      client = awsIot.device({
        region: cfg.region,
        host: cfg.iotEndpoint,
        protocol: "wss",
        clientId: clientId,
        accessKeyId: AWS.config.credentials.accessKeyId,
        secretKey: AWS.config.credentials.secretAccessKey,
        sessionToken: AWS.config.credentials.sessionToken,
        debug: true
      });
      
      log("‚è≥ Conectando a " + cfg.iotEndpoint + "...");
      
      client.on("connect", () => {
        log("üöÄ ¬°CONECTADO A AWS IOT CORE!");
        log("üì° Suscribi√©ndose al topic 'test/topic'...");
        
        client.subscribe("test/topic", (err) => {
          if (err) {
            log("‚ùå Error al suscribirse: " + err.message);
          } else {
            log("‚úÖ Suscrito a 'test/topic'");
            document.getElementById("btnPublicar").disabled = false;
          }
        });
      });
      
      client.on("message", (topic, payload) => {
        log("üì® Mensaje recibido en '" + topic + "': " + payload.toString());
      });
      
      client.on("error", (error) => {
        log("‚ùå Error de IoT: " + error.message);
        console.error("Error completo:", error);
      });
      
      client.on("close", () => {
        log("üîå Conexi√≥n cerrada");
        document.getElementById("btnPublicar").disabled = true;
      });
      
      client.on("offline", () => {
        log("üìµ Cliente offline");
      });
      
      client.on("reconnect", () => {
        log("üîÑ Reconectando...");
      });
      
    } catch (error) {
      log("‚ùå Error creando cliente: " + error.message);
      console.error("Error completo:", error);
    }
  });
}

function publicar() {
  if (!client) {
    log("‚ùå No hay conexi√≥n activa");
    return;
  }
  
  const mensaje = {
    timestamp: new Date().toISOString(),
    mensaje: "Hola desde el navegador",
    random: Math.random()
  };
  
  log("üì§ Publicando mensaje...");
  client.publish("test/topic", JSON.stringify(mensaje), (err) => {
    if (err) {
      log("‚ùå Error publicando: " + err.message);
    } else {
      log("‚úÖ Mensaje publicado");
    }
  });
}
</script>

<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    max-width: 800px;
    margin: 0 auto;
  }
  button {
    padding: 10px 20px;
    margin: 5px;
    font-size: 14px;
    cursor: pointer;
  }
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  #log {
    background: #1e1e1e;
    color: #00ff00;
    padding: 15px;
    border-radius: 5px;
    max-height: 500px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    margin-top: 20px;
  }
</style>
</body>
</html>
