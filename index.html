<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AWS IoT Web - MQTT</title>
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1370.0.min.js"></script>
  <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
</head>
<body>
<h2>AWS IoT Web - MQTT.js</h2>
<button onclick="conectar()">Conectar a AWS IoT</button>
<button onclick="publicar()" id="btnPublicar" disabled>Publicar Mensaje</button>
<button onclick="limpiar()">Limpiar Log</button>
<pre id="log"></pre>

<script>
let client = null;

const log = (m) => {
  const timestamp = new Date().toLocaleTimeString();
  const msg = `[${timestamp}] ${m}`;
  console.log(msg);
  document.getElementById("log").textContent += msg + "\n";
  document.getElementById("log").scrollTop = document.getElementById("log").scrollHeight;
};

function limpiar() {
  document.getElementById("log").textContent = "";
}

window.addEventListener('load', () => {
  log("üìÑ P√°gina cargada");
  log("AWS SDK: " + (typeof AWS !== 'undefined' ? '‚úÖ' : '‚ùå'));
  log("MQTT.js: " + (typeof mqtt !== 'undefined' ? '‚úÖ' : '‚ùå'));
});

const cfg = {
  region: "us-east-1",
  identityPoolId: "us-east-1:7860e2f2-eb64-4494-9c2a-fe735c8912ec",
  iotEndpoint: "a1eyoxsww0xvbl-ats.iot.us-east-1.amazonaws.com"
};

AWS.config.region = cfg.region;
AWS.config.credentials = new AWS.CognitoIdentityCredentials({
  IdentityPoolId: cfg.identityPoolId
});

function conectar() {
  if (typeof mqtt === 'undefined') {
    log("‚ùå MQTT.js no disponible");
    return;
  }
  
  log("üîÑ Iniciando conexi√≥n...");
  log("üîë Solicitando credenciales de Cognito...");
  
  AWS.config.credentials.get((err) => {
    if (err) {
      log("‚ùå Error obteniendo credenciales: " + err.message);
      return;
    }
    
    log("‚úÖ Credenciales obtenidas");
    
    const clientId = "web-client-" + Math.floor(Math.random() * 100000);
    log("üì± ClientId: " + clientId);
    
    // Crear URL firmada para WebSocket
    const url = createPresignedUrl(
      cfg.iotEndpoint,
      cfg.region,
      AWS.config.credentials.accessKeyId,
      AWS.config.credentials.secretAccessKey,
      AWS.config.credentials.sessionToken
    );
    
    log("‚è≥ Conectando via WebSocket...");
    
    client = mqtt.connect(url, {
      clientId: clientId,
      transformWsUrl: () => url,
      keepalive: 30,
      connectTimeout: 30000
    });
    
    client.on("connect", () => {
      log("üöÄ ¬°CONECTADO A AWS IOT CORE!");
      log("üì° Suscribi√©ndose a 'test/topic'...");
      
      client.subscribe("test/topic", (err) => {
        if (err) {
          log("‚ùå Error al suscribirse: " + err.message);
        } else {
          log("‚úÖ Suscrito a 'test/topic'");
          document.getElementById("btnPublicar").disabled = false;
        }
      });
    });
    
    client.on("message", (topic, message) => {
      log("üì® Mensaje en '" + topic + "': " + message.toString());
    });
    
    client.on("error", (error) => {
      log("‚ùå Error: " + error.message);
    });
    
    client.on("close", () => {
      log("üîå Conexi√≥n cerrada");
      document.getElementById("btnPublicar").disabled = true;
    });
    
    client.on("offline", () => {
      log("üìµ Cliente offline");
    });
  });
}

function publicar() {
  if (!client || !client.connected) {
    log("‚ùå No hay conexi√≥n activa");
    return;
  }
  
  const mensaje = JSON.stringify({
    timestamp: new Date().toISOString(),
    mensaje: "Hola desde MQTT.js",
    random: Math.random()
  });
  
  log("üì§ Publicando mensaje...");
  client.publish("test/topic", mensaje, (err) => {
    if (err) {
      log("‚ùå Error publicando: " + err.message);
    } else {
      log("‚úÖ Mensaje publicado");
    }
  });
}

// Funci√≥n para crear URL firmada (SigV4)
function createPresignedUrl(endpoint, region, accessKey, secretKey, sessionToken) {
  const datetime = new Date().toISOString().replace(/[:-]|\.\d{3}/g, '');
  const date = datetime.substr(0, 8);
  
  const method = 'GET';
  const protocol = 'wss';
  const uri = '/mqtt';
  const service = 'iotdevicegateway';
  const algorithm = 'AWS4-HMAC-SHA256';
  
  const credentialScope = date + '/' + region + '/' + service + '/' + 'aws4_request';
  const canonicalQuerystring = 'X-Amz-Algorithm=' + algorithm +
    '&X-Amz-Credential=' + encodeURIComponent(accessKey + '/' + credentialScope) +
    '&X-Amz-Date=' + datetime +
    '&X-Amz-SignedHeaders=host';
  
  const canonicalHeaders = 'host:' + endpoint + '\n';
  const payloadHash = sha256('');
  const canonicalRequest = method + '\n' + uri + '\n' + canonicalQuerystring + '\n' + 
    canonicalHeaders + '\nhost\n' + payloadHash;
  
  const stringToSign = algorithm + '\n' + datetime + '\n' + credentialScope + '\n' + 
    sha256(canonicalRequest);
  
  const signingKey = getSignatureKey(secretKey, date, region, service);
  const signature = hmac(signingKey, stringToSign);
  
  let finalParams = canonicalQuerystring + '&X-Amz-Signature=' + signature;
  if (sessionToken) {
    finalParams += '&X-Amz-Security-Token=' + encodeURIComponent(sessionToken);
  }
  
  return protocol + '://' + endpoint + uri + '?' + finalParams;
}

// Funciones auxiliares para firma AWS
function sha256(data) {
  return AWS.util.crypto.sha256(data, 'hex');
}

function hmac(key, data) {
  return AWS.util.crypto.hmac(key, data, 'hex');
}

function getSignatureKey(key, dateStamp, regionName, serviceName) {
  const kDate = AWS.util.crypto.hmac('AWS4' + key, dateStamp);
  const kRegion = AWS.util.crypto.hmac(kDate, regionName);
  const kService = AWS.util.crypto.hmac(kRegion, serviceName);
  const kSigning = AWS.util.crypto.hmac(kService, 'aws4_request');
  return kSigning;
}
</script>

<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    max-width: 800px;
    margin: 0 auto;
  }
  button {
    padding: 10px 20px;
    margin: 5px;
    font-size: 14px;
    cursor: pointer;
  }
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  #log {
    background: #1e1e1e;
    color: #00ff00;
    padding: 15px;
    border-radius: 5px;
    max-height: 500px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    margin-top: 20px;
  }
</style>
</body>
</html>
