<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Prueba AWS Cognito + IoT Core</title>

  <!-- AWS SDK -->
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1370.0.min.js"></script>

  <!-- AWS IoT SDK (MQTT over WebSocket) -->
  <script src="https://unpkg.com/aws-iot-device-sdk/browser/aws-iot-sdk-browser-bundle.min.js"></script>

  <!-- Configuraci√≥n AWS -->
  <script src="aws-config.js"></script>
</head>

<body>

<!-- TEXTO DE VERIFICACI√ìN -->
<p style="color: green; font-weight: bold;">
  ‚úÖ SI VES ESTE TEXTO, ESTE ES EL HTML CORRECTO
</p>

<h2>Prueba AWS Cognito + AWS IoT Core</h2>

<!-- BOTONES -->
<button onclick="probarCredenciales()">1Ô∏è‚É£ Probar credenciales Cognito</button>
<br><br>
<button onclick="conectarIoT()">2Ô∏è‚É£ Conectar a AWS IoT</button>

<hr>

<p>Abre la consola del navegador (F12) para ver los mensajes.</p>

<script>
/* =========================
   VERIFICACI√ìN DE CARGA
   ========================= */
console.log("üìÑ index.html cargado correctamente");
console.log("üì¶ awsConfig:", window.awsConfig);

/* =========================
   PASO 1: PROBAR COGNITO
   ========================= */
function probarCredenciales() {

  console.log("üîÑ Probando credenciales Cognito...");

  if (!window.awsConfig) {
    console.error("‚ùå aws-config.js NO est√° cargado");
    return;
  }

  AWS.config.region = awsConfig.region;

  AWS.config.credentials = new AWS.CognitoIdentityCredentials({
    IdentityPoolId: awsConfig.identityPoolId
  });

  AWS.config.credentials.get(function (err) {
    if (err) {
      console.error("‚ùå Error Cognito", err);
    } else {
      console.log("‚úÖ Credenciales obtenidas");
      console.log("üîë AccessKey:", AWS.config.credentials.accessKeyId);
    }
  });
}

/* =========================
   PASO 2: CONECTAR A IOT
   ========================= */
function conectarIoT() {

  console.log("üîÑ Conectando a AWS IoT Core...");

  if (!AWS.config.credentials) {
    console.warn("‚ö†Ô∏è Credenciales no inicializadas, ejecutando Cognito primero");
    probarCredenciales();
  }

  AWS.config.credentials.get(function (err) {
    if (err) {
      console.error("‚ùå Error Cognito", err);
      return;
    }

    console.log("‚úÖ Credenciales OK, creando cliente MQTT");

    const client = awsIot.device({
      region: awsConfig.region,
      protocol: "wss",
      host: awsConfig.iotEndpoint,

      accessKeyId: AWS.config.credentials.accessKeyId,
      secretKey: AWS.config.credentials.secretAccessKey,
      sessionToken: AWS.config.credentials.sessionToken,

      debug: true
    });

    client.on("connect", () => {
      console.log("üöÄ CONECTADO A AWS IOT CORE");
    });

    client.on("error", (err) => {
      console.error("‚ùå Error AWS IoT", err);
    });
  });
}
</script>

</body>
</html>
