<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>AWS IoT Web</title>

  <!-- AWS SDK v2 -->
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1370.0.min.js"></script>

  <!-- MQTT.js -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>

<h2>AWS IoT Web</h2>
<button onclick="conectarIoT()">Conectar a AWS IoT</button>

<pre id="log"></pre>

<script>
const log = (msg) => {
  console.log(msg);
  document.getElementById("log").textContent += msg + "\n";
};

const awsConfig = {
  region: "us-east-1",
  identityPoolId: "us-east-1:7860e2f2-eb64-4494-9c2a-fe735c8912ec",
  iotEndpoint: "a1eyoxsww0xvbl-ats.iot.us-east-1.amazonaws.com"
};

log("üìÑ index.html cargado correctamente");
log("üì¶ awsConfig cargado");

AWS.config.region = awsConfig.region;
AWS.config.credentials = new AWS.CognitoIdentityCredentials({
  IdentityPoolId: awsConfig.identityPoolId
});

function conectarIoT() {
  log("üîÑ Obteniendo credenciales Cognito...");

  AWS.config.credentials.get((err) => {
    if (err) {
      log("‚ùå Error Cognito: " + err);
      return;
    }

    log("‚úÖ Credenciales OK");

    const { accessKeyId, secretAccessKey, sessionToken } = AWS.config.credentials;

    const url = `wss://${awsConfig.iotEndpoint}/mqtt`;

    const client = mqtt.connect(url, {
      protocol: "wss",
      clientId: "web-" + Math.random().toString(16).substr(2, 8),
      username: accessKeyId,
      password: "",
      transformWsUrl: (url, options, client) => {
        return AWS.util.signRequest({
          method: "GET",
          url,
          headers: {
            "X-Amz-Security-Token": sessionToken
          }
        }, {
          accessKeyId,
          secretAccessKey,
          sessionToken
        }).url;
      }
    });

    client.on("connect", () => {
      log("üöÄ Conectado a AWS IoT");
      client.subscribe("esp32/test");
    });

    client.on("message", (topic, message) => {
      log(`üì© ${topic}: ${message.toString()}`);
    });

    client.on("error", (e) => {
      log("‚ùå MQTT error: " + e.message);
    });
  });
}
</script>

</body>
</html>
